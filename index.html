<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png?v=1">
	<title>Twitchat</title>
	<meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport' />
	<meta name="description" content="Full featured Twitch chat alternative that tries to fill in gaps of the official Twitch chat" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="expires" content="0">
	<meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">

	<meta property="og:url" content="https://twitchat.fr" />
	<meta property="og:type" content="website" />
	<meta property="og:title" content="Twitchat" />
	<meta property="og:description" content="Full featured Twitch chat alternative that tries to fill in gaps of the official Twitch chat" />
	<meta property="og:image" content="https://twitchat.fr/share.png?v=1" />
	<meta property="og:image" content="https://twitchat.fr/share_small.png?v=1" />
	<meta property="og:image:type" content="image/png" />
	<meta property="og:locale" content="fr_FR" />
	<meta property="og:locale:alternate" content="en_GB" />
	<meta name="revisit-after" content="30 days">
	<meta name="robots" content="index, follow">
	<link rel="author" href="https://www.durss.ninja" />
	<link rel="canonical" href="https://twitchat.fr/">
	<link rel="manifest" href="/manifest.json">
	<style>
		body {
			background-color: transparent;
		}
		#loader-init {
			position: absolute;
			transform: translate(-50%, -50%);
			top: 50%;
			left: 50%;
			width: 80px;
			height: 80px;
		}
		#error {
			display: flex;
			background-color: #bb3c3c;
			color: #fff;
			width: 100vw;
			height: 100vh;
			display: flex;
			font-size: max(5vh, 5vw);
			flex-direction: column;
			align-items: center;
			justify-content: center;
			text-align: center;
			border-radius: 5vw;
		}
	</style>
</head>

<body>
	<script type="text/javascript">
		/**
		 * Check for script loading error
		 * Tries to load it with cache cleaning 10 more times
		 * then show a fullscreen error if it failed 10 times.
		 * This is mostly done for OBS overlays as the cache
		 * there seems to be a little annoying sometimes
		 */
		function onLoadError(error, script) {
			const SERVER_PORT = 3018;
			const IS_PROD = document.location.hostname != "localhost" && document.location.hostname != "192.168.1.10";
			let API_PATH = "/api";
			if(!IS_PROD) {
				API_PATH = document.location.protocol+"//"+document.location.hostname+":"+SERVER_PORT+"/api";
			}

			const url = new URL(API_PATH+"/script");
			let date = parseInt(url.searchParams.get("ck"));
			let counter = parseInt(url.searchParams.get("cki"));
			if(isNaN(counter)) counter = 0;
			if(!isNaN(date) && Date.now() - date > 30 * 1000) counter = 0;
			counter ++;
			url.searchParams.set("ck", Date.now());
			url.searchParams.set("cki", counter);
			document.getElementById("loader-init").style.display = "none";
			//Stop spamming script refresh after 10 attempts
			if(counter <= 10) {
				setTimeout(()=>{
					document.head.removeChild(script);
					let s = document.createElement('script');
					s.defer = true;
					s.type = script.type;
					s.crossOrigin = script.crossOrigin;
					s.src = url.href;
					s.addEventListener("error", (error)=>onLoadError(error, s));
					document.head.append(s);
				}, 250)
			}else{
				document.getElementById("error").style.display = "flex";
			}
		}
		document.querySelectorAll("script").forEach(function(script) {
			if(/index.*\.js/.test(script.src)) {
				script.addEventListener("error", (error)=>onLoadError(error, script));
			}
		});
	</script>

	<noscript>
		<strong>We're sorry but Twitchat cannot work without JavaScript enabled. Please enable it to continue.</strong>
	</noscript>
	
	<img src="/loader_white.svg" alt="loader" style="display: none;" id="loader-init">
	
	<div id="app"></div>
	<!-- built files will be auto injected -->
	
	<div id="error" style="display: none;">
		<div>Twitchat failed loading :(</div>
		<div>Try refreshing and cleaning up your cache!</div>
	</div>

	<script type="text/javascript">
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/service-worker.js')
			.then((reg) => {
				console.log("Service worker registered");
			}).catch((err) => {
				console.log("Service worker registration failed:" + err);
			});
		}

		//Force transparent background for specifc routes.
		//This is also done on vue's side but we want it to be active
		//when vue is loading as well for these routes so we don't have
		//a black screen showing up.
		const noBgPaths = ["overlay/*"];
		const url = document.location.pathname;
		let showLoader = true;
		for (let i = 0; i < noBgPaths.length; i++) {
			const p = noBgPaths[i];
			if(new RegExp(p).test(url)) {
				showLoader = false;
				break;
			}
		}

		if(showLoader) {
			document.body.style.backgroundColor = "#18181b";
			document.getElementById("loader-init").style.display = "block";
		}
	</script>
	<script type="module" onerror="onLoadError()" src="/src/main.ts"></script>
</body>

</html>