<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>fr.twitchat.action</title>
	<link rel="stylesheet" href="css/sdpi.css">
	<style>
		.hidden {
			display: none;
		}

		.obsParams>.warning {
			background-color: #8b0000;
		}
		.obsParams {
			background-color: rgba(139, 0, 0,.25);
			padding-bottom: 4px;
			display: none;
		}
		details a {
			padding-right: 0;
		}

		.description {
			width: 100%;
			text-align: center;
			min-height: unset !important;
		}
	</style>
	<script type="text/javascript" src="js/obs-websocket.js"></script>
	<script type="text/javascript" src="js/action.js"></script>
	<script type="text/javascript" src="js/constants.js"></script>
	<script type="text/javascript" src="js/prototypes.js"></script>
	<script type="text/javascript" src="js/timers.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/events.js"></script>
	<script type="text/javascript" src="js/api.js"></script>
	<script type="text/javascript" src="js/property-inspector.js"></script>
	<script type="text/javascript" src="js/dynamic-styles.js"></script>
</head>

<body>
	<div class="sdpi-wrapper">
		<div id="obsParams" class="obsParams">
			<div class="sdpi-heading">OBS Websocket credentials</div>
			<div class="sdpi-item warning">
				<summary>Set your OBS-Websocket (v5+) credentials <i>(mandatory !)</i></summary>
			</div>
			<div class="sdpi-item">
				<div class="sdpi-item-label">Port</div>
				<input class="sdpi-item-value" value="4455" placeholder="4455" id="OBSWS_PORT">
			</div>
			<div class="sdpi-item">
				<div class="sdpi-item-label">Pass</div>
				<input class="sdpi-item-value" type="password" value="" id="OBSWS_PASS">
			</div>
			<div class="sdpi-item">
				<div class="sdpi-item-label">IP</div>
				<input class="sdpi-item-value" value="127.0.0.1" placeholder="127.0.0.1" id="OBSWS_IP">
			</div>
			<div class="sdpi-item">
				<details class="sdpi-item-value">
					<summary>Where can i find these values?</summary>
					<p>You can find these values on OBS under the <strong>"Tools -> obs-websocket"</strong> menu.</p>
					<p>
						Make sure you have <strong>OBS 28+</strong>
						<br><i>(or OBS 27 with <a href="https://github.com/obsproject/obs-websocket/releases" target="_blank">OBS-Websocket v5+</a> installed)</i>
					</p>
				</details>
			</div><div class="sdpi-item">
				<button class="sdpi-item-value" onclick="onConnect()">Connect</button>
			</div>
		</div>

		<div class="sdpi-heading hidden" data-chat-feed-read data-greet-feed-read>Parameters</div>

		<div class="sdpi-item">
			<div class="message description">
				<strong class="hidden" data-chat-feed-read>Mark the specified number of messages as read in the chat feed</strong>
				<strong class="hidden" data-chat-feed-read-encoder>Freely move the read mark up and down</strong>
				<strong class="hidden" data-greet-feed-read>Remove the specified number of messages from the <strong>"Greet them"</strong> feed</strong>
				<strong class="hidden" data-chat-feed-scroll_up>Scroll the chat up by the specified amount of pixels</strong>
				<strong class="hidden" data-chat-feed-scroll_down>Scroll the chat down by the specified amount of pixels</strong>
				<strong class="hidden" data-chat-feed-scroll>Freely scroll your chat up and down</strong>
				<strong class="hidden" data-shoutout>Using this button will send a shoutout to the latest user that raided your channel. It will do nothing until someone raided you.</strong>
				<strong class="hidden" data-chat-feed-select>Use this button to select a user's message and take moderation actions on it.</strong>
				<strong class="hidden" data-clear-chat-highlight>Clear the currently highlighted message. This needs the "Message Highlight" overlay to be configured on OBS.</strong>
			</div>
		</div>

		<hr>

		<div type="range" class="sdpi-item hidden"
		data-chat-feed-read
		data-greet-feed-read
		data-chat-feed-scroll-up
		data-chat-feed-scroll-down>
			<div class="sdpi-item-label">Count <i>(<span id="value"></span>)</i></div>
			<div class="sdpi-item-value range">
				<input class="setvalueSlider hidden" data-sync type="range" min="1" max="20" value="1"
					id="readCount"
					oninput="onChangeValue('greet-feed-read', Number(event.target.value))"
					data-greet-feed-read
					data-chat-feed-read>
					
				<input class="setvalueSlider hidden" data-sync type="range" min="100" max="1000" step="50" value="1"
					id="scrollAmount"
					oninput="onChangeValue('chat-feed-scroll-up', Number(event.target.value))"
					data-chat-feed-scroll-up
					data-chat-feed-scroll-down>
					
			</div>
		</div>

		<div class="sdpi-item" id="select_single" hidden
		data-chat-feed-select
		data-chat-feed-read
		data-chat-feed-read-encoder
		data-chat-feed-pause
		data-chat-feed-unpause
		data-chat-feed-scroll
		data-chat-feed-scroll-up
		data-chat-feed-scroll-down>
			<div class="sdpi-item-label">Column index to control</div>
			<select class="sdpi-item-value select"
				id="colIndex"
				oninput="onChangeValue('greet-feed-read', Number(event.target.value))"
				data-chat-feed-select
				data-chat-feed-read
				data-chat-feed-read-encoder
				data-chat-feed-pause
				data-chat-feed-unpause
				data-chat-feed-scroll
				data-chat-feed-scroll-up
				data-chat-feed-scroll-down>
			</select>
		</div>
		
		<!-- <div class="sdpi-item">
			<button class="sdpi-item-value" onclick="onTest()">Test action</button>
		</div> -->
	</div>

	<script>
		let actionName = "";
		let globalSettings = {};
		let isFirstUpdate = true;
		if ($PI) {

			$PI.onConnected(({ actionInfo, appInfo, connection, messageType, port, uuid }) => {

				$PI.onDidReceiveGlobalSettings((jsonObj) => {
					const settings = jsonObj.payload.settings;
					globalSettings = settings;
					populateGlobalSettings(settings);
					if(isFirstUpdate) {
						$PI.getSettings();
					}
				});

				$PI.onDidReceiveSettings($PI.actionInfo.action, (jsonObj) => {
					console.log("Settings received", jsonObj);
					const settings = jsonObj.payload.settings;
					populateLocalSettings(settings);
				});

				actionName = $PI.actionInfo.action.split(".").pop();

				//Make visible any component related to this action
				const holders = document.querySelectorAll("[data-"+actionName+"]");
				for (let i = 0; i < holders.length; i++) {
					const el = holders[i];
					el.classList.remove("hidden");
				}

				//Remove from the DOM any holder with a "hidden" class remaining
				const holdersRemove = document.querySelectorAll(".hidden");
				for (let i = 0; i < holdersRemove.length; i++) {
					const el = holdersRemove[i];
					el.parentElement.removeChild(el);
				}

				//Request settings
				$PI.getGlobalSettings();
			});
		};

		function populateGlobalSettings(settings) {
			const colSelector = document.getElementById("colIndex");
			colSelector.innerHTML = "";
			for (let i = 0; i < settings.COLS_COUNT; i++) {
				const opt = document.createElement("option");
				opt.value = i,
				opt.innerText = i+1;
				colSelector.appendChild(opt);
			}

			for (const key in settings) {
				const input = document.getElementById(key);
				if(input) {
					input.value = settings[key];
					if(input.dataset.hasOwnProperty("sync")) {
						if(document.getElementById("value")) document.getElementById("value").innerHTML = settings[key];
					}
				}
			}
			document.getElementById("obsParams").style.display = settings.OBSWS_CONNECTED? "none" : "block";
			
		}

		function populateLocalSettings(settings) {
			for (const key in settings) {
				const input = document.getElementById(key);
				if(input) {
					input.value = settings[key];
					if(input.dataset.hasOwnProperty("sync")) {
						if(document.getElementById("value")) document.getElementById("value").innerHTML = settings[key];
					}
				}
			}
			
		}

		function onChangeValue(paramName, paramValue, saveGlobal) {
			var payload = {saveGlobal:saveGlobal === true, data:{}};
			if(!paramValue) paramValue = true;
			payload.data[paramName] = paramValue;

			const holders = document.querySelectorAll("[data-"+actionName+"]");
			
			const settings = {};
			for (let i = 0; i < holders.length; i++) {
				const element = holders[i];
				const prop = element.getAttribute("id");
				if(!prop || element.value == undefined) continue;
				settings[prop] = element.value;
			}

			$PI.setSettings(settings);
		}

		function onConnect() {
			const port = document.getElementById("OBSWS_PORT").value;
			const pass = document.getElementById("OBSWS_PASS").value;
			const ip = document.getElementById("OBSWS_IP").value;
			const settings = {port, pass, ip};
			globalSettings["OBSW_DO_CONNECT"] = settings;
			$PI.setGlobalSettings(globalSettings);
			$PI.sendToPlugin({OBSW_DO_CONNECT:settings})
		}

		function onTest() {
			$PI.sendToPlugin({TEST_ACTION:actionName});
		}

		function onGetColsCount() {
			$PI.sendToPlugin({GET_COLS_COUNT:true});
		}

	</script>

</body>

</html>