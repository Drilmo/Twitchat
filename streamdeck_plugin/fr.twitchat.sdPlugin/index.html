<!DOCTYPE HTML>
<html>

<head>
	<title>fr.twitchat</title>
	<meta charset="utf-8" />
</head>

<body>
	<script>

		let websocket = null;
		let pluginUUID = null;
		const settingsCache = {
			GREET_FEED_READ: 1,
			CHAT_FEED_READ: 1,
			CHAT_FEED_SCROLL_UP: 100,
			CHAT_FEED_SCROLL_DOWN: 100,
			OBSWS_PORT: "",
			OBSWS_PASS: "",
			OBSWS_CONNECTED: false,
		};

		var DestinationEnum = Object.freeze({ "HARDWARE_AND_SOFTWARE": 0, "HARDWARE_ONLY": 1, "SOFTWARE_ONLY": 2 })

		var actions = {

			type: "fr.twitchat.action",

			onKeyUp: (context, settings, coordinates, userDesiredState) => {
				console.log("KEY UP", settings);
				// this.SetTitle(context, keyPressCounter);
			},

			onWillAppear: (context, settings, coordinates) => {
				for (const key in settingsCache) {
					if (settings.hasOwnProperty(key)) {
						settingsCache[key] = settings[key];
					}
				}
				// this.SetTitle(context, keyPressCounter);
			},

			SetTitle: (context, value) => {
				var json = {
					"event": "setTitle",
					"context": context,
					"payload": {
						"title": "" + value,
						"target": DestinationEnum.HARDWARE_AND_SOFTWARE
					}
				};

				websocket.send(JSON.stringify(json));
			},

			SetSettings: (context, settings) => {
				var json = {
					"event": "setSettings",
					"context": context,
					"payload": settings
				};

				websocket.send(JSON.stringify(json));
			},

			AddToSettings: (context, newSettings) => {
				settingsCache[context] = newSettings;
			}
		};

		function connectElgatoStreamDeckSocket(port, pluginUUID, registerEvent, info) {
			websocket = new WebSocket("ws://127.0.0.1:" + port);

			websocket.onopen = () => {
				var json = {
					"event": registerEvent,
					"uuid": pluginUUID,
				};
				websocket.send(JSON.stringify(json));
				// actions.SetSettings(context,settingsCache);
			};

			websocket.onmessage = (evt) => {
				// Received message from Stream Deck
				const jsonObj = JSON.parse(evt.data);
				const event = jsonObj['event'];
				const action = jsonObj['action'];
				const context = jsonObj['context'];
				const jsonPayload = jsonObj['payload'] || {};

				console.log(event);

				if(event == "willAppear") {
					//Initialize settings by merging local defaults with stored values
					var settings = jsonPayload.settings;
					for (const key in settings) {
						settingsCache[key] = settings[key];
					}
					actions.SetSettings(context,settingsCache);
				}
				else if (event == "keyUp") {
					var settings = jsonPayload['settings'];
					var coordinates = jsonPayload['coordinates'];
					var userDesiredState = jsonPayload['userDesiredState'];
					actions.onKeyUp(context, settings, coordinates, userDesiredState);
				}
				else if (event == "willAppear") {
					var settings = jsonPayload['settings'];
					var coordinates = jsonPayload['coordinates'];
					actions.onWillAppear(context, settings, coordinates);
				}
				else if (event == "sendToPlugin") {
					console.log(jsonPayload);
					for (const key in jsonPayload) {
						if (settingsCache.hasOwnProperty(key)) {
							var newValue = jsonPayload[key];
							console.log("Save",key, newValue);
							settingsCache[key] = newValue;
							actions.SetSettings(context,settingsCache);
							actions.SetTitle(context, newValue);
						}
					}
				}
			};

			websocket.onclose = () => {
				// Websocket is closed
			};
		};
	</script>

</body>

</html>
